# STdGCN 使用手册

本手册将指导您如何部署和运行 STdGCN (Spatial Transcriptomics deconvolution using Graph Convolutional Networks) 及其配套的可视化系统。本项目支持在 Windows 和 Linux 环境下运行。

## 1. 项目简介

STdGCN 是一个基于图卷积网络的方法，利用单细胞数据（scRNA-seq）作为参考，对空间转录组（Spatial Transcriptomics）数据进行细胞类型反卷积。

本项目在前作基础上进行了以下改进：
*   新增 **交互式 Web 可视化系统**（基于 Streamlit），支持缩放、悬停查看详情。
*   优化了绘图逻辑，自动生成适配 Web 的高清资源。
*   提供了一键启动脚本，简化操作流程。

---

## 2. 环境配置

### Windows 用户
本项目内置了 `_miniconda` 环境（如果包含在压缩包中），您可以直接使用。
如果您需要自己配置环境（例如下载的是源码包），请按照以下步骤操作：

1.  安装 Anaconda 或 Miniconda。
2.  创建环境并安装依赖：
    ```bash
    conda create -n stdgcn python=3.9
    conda activate stdgcn
    # 根据您的显卡安装 PyTorch (访问 pytorch.org 获取适合的命令)
    pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu118
    # 安装其他依赖
    pip install scanpy pandas numpy matplotlib seaborn scikit-learn tqdm notebook streamlit
    pip install torch-geometric torch-scatter torch-sparse torch-cluster torch-spline-conv -f https://data.pyg.org/whl/torch-2.0.0+cu118.html
    ```

### Linux 用户
Linux 环境需要手动配置 Conda 环境。

1.  确保已安装 Conda。
2.  使用上述 Windows 部分相同的命令创建环境 `stdgcn`。
3.  确保安装了 `streamlit` 以支持可视化：
    ```bash
    pip install streamlit
    ```

---

## 3. 数据准备

请确保项目根目录下存在 `data` 文件夹，并包含以下格式的数据：

```text
data/
└── your_dataset_name/
    ├── sc_data.tsv        # 单细胞表达矩阵 (行:细胞, 列:基因)
    ├── sc_label.tsv       # 单细胞类型注释 (Barcode, CellType)
    ├── ST_data.tsv        # 空间转录组表达矩阵 (行:Spot, 列:基因)
    ├── coordinates.csv    # 空间坐标文件 (index, x, y)
    └── [可选] marker_genes.tsv / ST_ground_truth.tsv
```

*注意：为了顺利运行演示，请检查 `Tutorial.py` 中的 `paths` 变量是否指向了正确的数据路径。*

---

## 4. 模型训练 (运行 STdGCN)

模型训练将读取数据，训练图神经网络，并输出预测的细胞类型比例。

### 设置参数
打开 `Tutorial.py`，您可以修改以下关键参数：
*   `paths`: 设置输入数据路径 (`sc_path`, `ST_path`) 和输出路径 (`output_path`)。
*   `generate_new_pseudo_spots`: 是否重新生成伪斑点（首次运行时设为 `True`）。
*   `cell_type_distribution_plot`: 是否生成单细胞类型的静态热力图（建议设为 `False` 以节省时间，Web 端可交互查看）。
*   `fraction_pie_plot`: 是否生成静态饼图。

### 启动训练

**Windows:**
双击运行 **`run_tutorial.bat`** 脚本。

**Linux:**
在终端中运行：
```bash
chmod +x run_tutorial.sh
./run_tutorial.sh
```

**运行结果:**
结果将保存在 `output/` 目录下，包括：
*   `predict_result.csv`: 预测比例表。
*   `results.h5ad`: Anndata 格式结果。
*   `interactive_pie_background.png`: 交互式可视化专用背景图。
*   `interactive_pie_bounds.json`: 可视化坐标元数据。

---

## 5. 结果可视化 (Web App)

训练完成后，您可以启动 Web 可视化系统来探索结果。

**Windows:**
双击运行 **`run_visualization.bat`** 脚本。
脚本会自动启动服务并打开默认浏览器。

**Linux:**
在终端中运行：
```bash
# 确保已激活 conda 环境
streamlit run visualization_app/app.py
```
然后通过浏览器访问显示的 URL (通常是 `http://localhost:8501`)。

### 可视化功能
1.  **空间组成分布 (多色饼图)**:
    *   交互式查看每个 Spot 的细胞组成。
    *   支持缩放和平移。
    *   侧边栏可调节悬停显示的细胞类型数量。
2.  **主要类型分布 (优势细胞)**:
    *   展示每个 Spot 占比最高的细胞类型。
    *   右侧图例支持点击筛选/隐藏特定类型。
3.  **单细胞类型热图**:
    *   选择特定细胞类型，查看其在空间上的分布热度。
    *   相比静态图片，支持更精细的数值查看。
4.  **整体比例统计**:
    *   展示所有 Spot 的平均细胞类型组成。

---

## 6. 常见问题 (FAQ)

**Q: 网页提示 "Data directories not found"?**
A: 请检查 `data` 和 `output` 文件夹是否存在。如果您是在新电脑上运行，请确保已经运行过 `Tutorial.py` 生成了结果。

**Q: 饼图看起来有边缘被切断？**
A: 这是一个已知问题，已在最新版代码中修复。请确保您的 `STdGCN/visualization.py` 是最新版本，并重新运行 `Tutorial.py` 以重新生成背景资源。

**Q: Linux 上运行报错 "ModuleNotFoundError"?**
A: 请确认您是否已激活了包含必要库 (torch, scanpy, streamlit 等) 的 Conda 环境。
